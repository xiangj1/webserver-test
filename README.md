# AstroChart + Swiss Ephemeris ç¤ºä¾‹ï¼ˆå¿…é¡»è¿è¡Œæœ¬åœ°æœåŠ¡ï¼‰

> é‡è¦ï¼šå½“å‰ `index.html` å·²æ”¹ä¸ºâ€œåŠ¨æ€è®¡ç®—â€ç‰ˆæœ¬ï¼Œä¼šè°ƒç”¨åç«¯æ¥å£ `/api/ephemeris` è·å–è¡Œæ˜Ÿä¸å®«ä½æ•°æ®ï¼›å› æ­¤**ä¸èƒ½åªåŒå‡»ç›´æ¥æ‰“å¼€**ã€‚è¯·åŠ¡å¿…å…ˆæ‰§è¡Œ `npm install` ç„¶å `npm start`ã€‚

æœ¬ä»“åº“æ¼”ç¤ºï¼š

1. ä½¿ç”¨ [Swiss Ephemeris (`swisseph`)](https://www.astro.com/swisseph/) åœ¨åç«¯è®¡ç®—è¡Œæ˜Ÿä½ç½®ä¸ 12 å®«é¦–
2. å‰ç«¯é€šè¿‡è¡¨å•å‘èµ·è¯·æ±‚ï¼Œè·å– JSON åç”¨ [AstroChart](https://github.com/AstroDraw/AstroChart) ç»˜åˆ¶æ˜Ÿç›˜
3. è¡Œæ˜Ÿç›¸ä½ï¼ˆ`radix.aspects()`ï¼‰ä¸é€†è¡Œé€Ÿåº¦å±•ç¤ºçš„åŸºç¡€ç»“æ„
4. å›é€€ç­–ç•¥ï¼šå®«ä½è®¡ç®—å¤±è´¥æ—¶è‡ªåŠ¨ç”¨ 30Â° å‡åˆ†å¡«å……ï¼ˆæ ‡è®° `cuspsSource: fallback`ï¼‰

å¦‚æœä½ åªæƒ³çœ‹ä¸€ä¸ªçº¯é™æ€ã€æ‰‹åŠ¨å†™æ­»æ•°æ®çš„æœ€å° AstroChart ä¾‹å­ï¼Œä¹Ÿä¿ç•™åœ¨ä¸‹æ–¹â€œé™„å½•ï¼šçº¯é™æ€ç‰ˆç¤ºä¾‹â€ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆå¿…é¡»ï¼‰

ç¡®ä¿å·²å®‰è£… Node.jsï¼ˆå»ºè®® >= 18ï¼‰ã€‚åœ¨ä»“åº“æ ¹ç›®å½•è¿è¡Œï¼š

```bash
npm install   # å®‰è£… express + swisseph ä¾èµ–
npm start     # å¯åŠ¨æœ¬åœ°æœåŠ¡ï¼Œé»˜è®¤ç«¯å£ 3000
```

ç„¶åæµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000/`

é¡µé¢ä¼šï¼š
1. åŠ è½½è¿œç¨‹ AstroChart è„šæœ¬ï¼ˆå¤±è´¥åˆ™å›é€€æœ¬åœ° `./astrochart.js`ï¼‰
2. è‡ªåŠ¨è§¦å‘è¡¨å•æäº¤ï¼ˆé»˜è®¤æ—¥æœŸ/ç»çº¬åº¦ï¼‰ï¼Œè¯·æ±‚åç«¯ `/api/ephemeris`
3. æ¸²æŸ“ 600x600 SVG æ˜Ÿç›˜å¹¶æ˜¾ç¤ºç›¸ä½

### ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥åŒå‡» `index.html`ï¼Ÿ

å› ä¸ºé¡µé¢å†…å«ï¼š
```js
fetch('/api/ephemeris?date=...')
```
åŒå‡»æ—¶æµè§ˆå™¨ä½¿ç”¨ `file://` åè®®ï¼Œæ²¡æœ‰è¿è¡Œä¸­çš„ Expressï¼Œä¹Ÿæ²¡æœ‰è¯¥è·¯å¾„ï¼Œ`fetch` ä¼šå¤±è´¥ï¼ŒçŠ¶æ€æ æ˜¾ç¤ºâ€œå¤±è´¥â€ã€‚

### ç«¯åˆ°ç«¯è°ƒç”¨æµç¨‹
```
Browser (form submit)
			â”‚  GET /api/ephemeris?date&tz&lat&lon&house
			â–¼
Express (server.js) â”€â”€â–º swisseph è®¡ç®—è¡Œæ˜Ÿ + å®«ä½ â”€â”€â–º JSON { planets, cusps, meta }
			â”‚
			â–¼
AstroChart å‰ç«¯æ¸²æŸ“ radix + aspects
```

### å…¸å‹è¿”å›ç»“æ„ï¼ˆå‹ç¼©ç¤ºä¾‹ï¼‰
```json
{
	"meta": {
		"jd": 2451234.56,
		"lat": 30.6,
		"lon": 114.3,
		"house": "P",
		"cuspsSource": "houses"
	},
	"planets": {
		"Sun": [146.123456, 0.985647],
		"Moon": [210.987654, -12.345678]
	},
	"cusps": [123.45, 156.78, 181.23, ... 12 ä¸ªå€¼]
}
```

### å¸¸è§é—®é¢˜ï¼ˆè¿è¡Œç‰ˆï¼‰
| é—®é¢˜ | åŸå›  | è§£å†³ |
|------|------|------|
| è®¿é—®å¤±è´¥æˆ–ç©ºç™½ | æ²¡æœ‰æ‰§è¡Œ `npm start` | å…ˆ `npm install && npm start` |
| çŠ¶æ€æ æ˜¾ç¤ºâ€œå¤±è´¥â€ | `/api/ephemeris` è¯·æ±‚ 404 / ç½‘ç»œé˜»æ–­ | ç¡®è®¤æœåŠ¡æ˜¯å¦å¯åŠ¨ã€ç«¯å£å ç”¨æƒ…å†µ |
| cuspsSource=fallback | å®«ä½è®¡ç®—æœªæˆåŠŸ | æ£€æŸ¥ `lat/lon/house` è¾“å…¥ï¼Œå°è¯•æ›´æ¢å®«ä½ç³»ç»Ÿ |
| é€†è¡Œæœªæ ‡è®° | ä»…é€Ÿåº¦ä¸ºè´Ÿæ‰è¡¨ç¤ºé€†è¡Œ | å¯åœ¨æ¸²æŸ“æ—¶è¿½åŠ  `R` æ–‡æœ¬ |
| raw.githubusercontent åŠ è½½å¤±è´¥ | ç½‘ç»œæˆ–è¢«å¢™ | ä½¿ç”¨æœ¬åœ° `astrochart.js`ï¼ˆå·²è‡ªåŠ¨å›é€€ï¼‰|
| ç«¯å£è¢«å ç”¨ | 3000 å·²è¢«å…¶å®ƒç¨‹åºä½¿ç”¨ | `PORT=4000 npm start` ä¿®æ”¹ç«¯å£ |

### ä¿®æ”¹ç«¯å£
```bash
PORT=4000 npm start
```
æˆ–åœ¨ shellï¼ˆmacOS zshï¼‰ä¸­ï¼š
```bash
export PORT=4000
npm start
```

---

## ğŸ“ ä¸»è¦æ–‡ä»¶
| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `server.js` | Express æœåŠ¡ + `/api/ephemeris` è¡Œæ˜Ÿä¸å®«ä½è®¡ç®— |
| `index.html` | å‰ç«¯è¡¨å• + åŠ¨æ€è¯·æ±‚ + AstroChart æ¸²æŸ“é€»è¾‘ |
| `astrochart.js` | AstroChart åº“æœ¬åœ°å¤‡ä»½ï¼ˆè¿œç¨‹å¤±è´¥æ—¶å›é€€ï¼‰ |
| `scripts/generate-data.js` | å•æ¬¡æ‰¹é‡ç”Ÿæˆ `data.json` çš„ CLIï¼ˆå¯ç¦»çº¿æ¼”ç¤ºï¼‰ |
| `package.json` | ä¾èµ–ä¸å¯åŠ¨è„šæœ¬å®šä¹‰ |

---

## ğŸ”„ å¯é€‰ï¼šç¦»çº¿ fallbackï¼ˆä¸è·‘åç«¯æ—¶ï¼‰
å¦‚åªæƒ³æ¼”ç¤ºæ¸²æŸ“ï¼Œä¸éœ€è¦åŠ¨æ€è¾“å…¥ï¼Œå¯ï¼š
1. æ‰§è¡Œ `npm run gen` ç”Ÿæˆ `data.json`
2. åœ¨ `index.html` å¢åŠ å†…åµŒ `const fallbackEphem = {...}` å¹¶åœ¨ `fetch` å¤±è´¥æ—¶è°ƒç”¨ `renderChart(fallbackEphem)`

ï¼ˆå½“å‰ README ä¸ç›´æ¥ä¿®æ”¹ç¤ºä¾‹ä»£ç ï¼Œä¿æŒåç«¯å¿…éœ€çš„é»˜è®¤è¡Œä¸ºã€‚ï¼‰

---

## ğŸ§ª å•æ¬¡æ•°æ®ç”Ÿæˆè„šæœ¬
```bash
npm run gen
```
ç”Ÿæˆçš„ `data.json` å¯è¢«å‰ç«¯ç›´æ¥ `fetch('./data.json')` ä½¿ç”¨ï¼ˆè‹¥ä»¥é™æ€æœåŠ¡å™¨æ–¹å¼æ‰˜ç®¡ï¼‰ã€‚

---

## é™„å½•ï¼šçº¯é™æ€ç‰ˆç¤ºä¾‹ï¼ˆä¸ä¾èµ–åç«¯ï¼Œä»…æ•™å­¦ï¼‰

> å¦‚æœä½ å¤åˆ¶ä¸‹åˆ—ç‰‡æ®µåˆ°ä¸€ä¸ªæ–°æ–‡ä»¶ `static-demo.html`ï¼Œå¯ä»¥ä¸è¿è¡Œåç«¯ç›´æ¥æ¼”ç¤ºæœ€åŸºæœ¬ç»˜åˆ¶ï¼ˆæ•°æ®æ‰‹å†™ï¼‰ã€‚å½“å‰ä»“åº“ä¸»é¡µé¢å·²é‡‡ç”¨åŠ¨æ€ API ç‰ˆæœ¬ï¼Œå‹¿æ··æ·†ã€‚

### æœ€å°æ•°æ®ç»“æ„
```html
<div id="chart"></div>
<script src="https://cdn.jsdelivr.net/npm/astrochart/dist/astrochart.js"></script>
<script>
	const data = {
		planets: { Sun: [281], Moon: [268] },
		cusps: [296,350,30,56,75,94,116,170,210,236,255,274]
	};
	const chart = new astrochart.Chart('chart', 600, 600);
	const radix = chart.radix(data);
	radix.addPointsOfInterest({ As:[data.cusps[0]], Ic:[data.cusps[3]], Ds:[data.cusps[6]], Mc:[data.cusps[9]] });
	radix.aspects();
</script>
```

### è¡Œæ˜Ÿ/å®«ä½æ•°æ®è¯´æ˜
```js
const data = {
	planets: {
		Sun: [281],
		Moon: [268]
		// ... å…¶å®ƒè¡Œæ˜Ÿ 0â€“359
	},
	cusps: [296,350,30,56,75,94,116,170,210,236,255,274] // æ°å¥½ 12 ä¸ª
};
```

---

## é€†è¡Œä¸ç›¸ä½è¡¥å……
é€Ÿåº¦ < 0 å¯è§†ä½œé€†è¡Œï¼š
```js
Object.entries(planets).forEach(([name,[lon,speed]]) => {
	if (speed < 0) console.log(name,'é€†è¡Œ');
});
```
è°ƒç”¨ç›¸ä½ï¼š
```js
radix.aspects();
```

---

## License / ç‰ˆæƒæé†’
Swiss Ephemeris æœ‰å…¶è®¸å¯æ¡æ¬¾ï¼Œç”Ÿäº§ç¯å¢ƒéœ€ç¡®è®¤åˆè§„ï¼›æ­¤ç¤ºä¾‹ä»…æ•™å­¦/æ¼”ç¤ºã€‚AstroChart ä¸ºå¼€æºåº“ï¼Œè¯·å‚è€ƒå…¶ä»“åº“ Licenseã€‚

---
éœ€è¦è¿›ä¸€æ­¥æ·»åŠ â€œç¦»çº¿è‡ªåŠ¨ fallback ç¤ºä¾‹â€æˆ–â€œtransit åŠ¨ç”»æ¼”ç¤ºâ€è¯·æå‡ºå³å¯ã€‚

<!-- ä»¥ä¸‹æ—§ç« èŠ‚å†…å®¹å·²åˆå¹¶åˆ°æ–°çš„ç»“æ„ä¸­ï¼Œä¿ç•™ä½œå‚è€ƒ -->

## ç»“æ„è¯´æ˜

`index.html` ä¸­çš„å…³é”®ä»£ç ï¼š

```html
<script src="https://cdn.jsdelivr.net/npm/astrochart/dist/astrochart.js"></script>
<script>
	const data = { planets: { Sun: [281], Moon: [268] }, cusps: [296,350,30,56,75,94,116,170,210,236,255,274] };
	const chart = new astrochart.Chart('chart', 600, 600);
	const radix = chart.radix(data);
	radix.addPointsOfInterest({ As:[data.cusps[0]], Ic:[data.cusps[3]], Ds:[data.cusps[6]], Mc:[data.cusps[9]] });
	radix.aspects();
</script>
```

## æ•°æ®æ ¼å¼å¿«é€Ÿå‚è€ƒ

```js
const data = {
	planets: {
		// è¡Œæ˜Ÿå: [åº¦æ•°, å¯é€‰é€Ÿåº¦]
		Sun: [281],
		Moon: [268]
		// ... å…¶ä½™è¡Œæ˜Ÿ 0â€“359 ä¹‹é—´
	},
	// 12 ä¸ªå®«é¦–ï¼ˆå¿…é¡»æ­£å¥½ 12 ä¸ªå€¼ï¼‰
	cusps: [296, 350, 30, 56, 75, 94, 116, 170, 210, 236, 255, 274]
};
```

## å¯é€‰ï¼šæœ¬åœ°é™æ€æœåŠ¡

è™½ç„¶ç›´æ¥åŒå‡»å¯è¿è¡Œï¼Œä½†å¦‚æœæƒ³é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ï¼ˆæ–¹ä¾¿ä»¥ååŠ æ¨¡å—åŒ–æˆ–è°ƒè¯• CORSï¼‰ï¼Œå¯ä»¥ï¼š

```bash
npx http-server . -p 8080
# ç„¶åè®¿é—® http://localhost:8080
```

## ä½¿ç”¨ NPMï¼ˆå¯é€‰è¿›é˜¶ï¼‰

```bash
npm init -y
npm install astrochart
```

åœ¨ä½ çš„æ‰“åŒ…å…¥å£ï¼ˆä¾‹å¦‚ `main.js`ï¼‰ï¼š

```js
import { Chart } from 'astrochart';
const data = { planets:{ Sun:[281], Moon:[268] }, cusps:[296,350,30,56,75,94,116,170,210,236,255,274] };
new Chart('chart', 600, 600).radix(data).aspects();
```

æ‰“åŒ…å·¥å…·ï¼ˆVite / Webpackï¼‰ä¼šè‡ªåŠ¨å¤„ç†ä¾èµ–ã€‚

## å¸¸è§é—®é¢˜ (FAQ)

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³ |
|------|----------|------|
| çœ‹ä¸åˆ°å›¾ | `#chart` å®¹å™¨ä¸å­˜åœ¨ | ç¡®è®¤ HTML é‡Œæœ‰ `<div id="chart"></div>` | 
| æ§åˆ¶å°æŠ¥ cusps æ•°é‡é”™è¯¯ | cusps ä¸æ˜¯ 12 ä¸ª | è¡¥é½æˆ–åˆ å‡åˆ° 12 ä¸ª | 
| CDN åŠ è½½å¤±è´¥ | ç½‘ç»œé™åˆ¶ | æ¢ unpkg æˆ–è‡ªå»ºæœ¬åœ° dist æ–‡ä»¶ | 
| ç›¸ä½çº¿æ²¡æœ‰æ˜¾ç¤º | æœªè°ƒç”¨ `radix.aspects()` | è¡¥è°ƒç”¨æˆ–æ£€æŸ¥è¡Œæ˜Ÿæ•°é‡ | 
| astrochart is not defined | è„šæœ¬å°šæœªåŠ è½½æˆ– CDN å¤±è´¥ | ä½¿ç”¨æ–°ç‰ˆ `index.html` æ¨¡æ¿(å«è½®è¯¢) æˆ–æ”¹ç”¨ npm å¼•å…¥ | 
| loadAstroFallback is not defined | onerror æ—¶å‡½æ•°å°šæœªå®šä¹‰ | ç¡®ä¿ fallback å‡½æ•°å†™åœ¨å¤–éƒ¨è„šæœ¬æ ‡ç­¾ä¹‹å‰ï¼ˆå·²åœ¨å½“å‰ç¤ºä¾‹ä¿®å¤ï¼‰ |
| /favicon.ico 404 | é»˜è®¤è¯·æ±‚å›¾æ ‡ä¸å­˜åœ¨ | å¯å¿½ç•¥æˆ–æ”¾ä¸€ä¸ªå°å›¾æ ‡åˆ°ä»“åº“æ ¹ç›®å½• | 
| ä¸¤ä¸ª CDN éƒ½å¤±è´¥ | å†…ç½‘æˆ–ä¸´æ—¶ç½‘ç»œé˜»æ–­ | ä¸‹è½½ `astrochart.js` åˆ°æœ¬åœ°æˆ– `npm install astrochart` å¹¶èµ°æœ¬åœ° fallback |

## ä¸‹ä¸€æ­¥å¯ä»¥åšä»€ä¹ˆï¼Ÿ

- æ·»åŠ  transitï¼ˆè¡Œè¿ï¼‰å¹¶ä½¿ç”¨ `radix.transit(transitData).aspects()`
- ä½¿ç”¨ `transit.animate()` åšåŠ¨ç”»
- è‡ªå®šä¹‰ `settings`ï¼ˆä¾‹å¦‚ `SYMBOL_SCALE`, `MARGIN`, `ASPECTS` é…è‰²ï¼‰

---
å¦‚æœä½ è¿˜éœ€è¦ä¸€ä¸ªåŒ…å« transit + åŠ¨ç”»çš„æœ€å°ç¤ºä¾‹ï¼Œå‘Šè¯‰æˆ‘å³å¯ã€‚ğŸ™‚

### è¿›é˜¶ï¼šå¦‚æœä¸¤ä¸ª CDN éƒ½ä¸å¯ç”¨

1. ä¸´æ—¶ä¸‹è½½ distï¼š
	```bash
	wget https://unpkg.com/astrochart/dist/astrochart.js -O astrochart.js
	```
2. æœ¬åœ°å¼•ç”¨ï¼š
	```html
	<script src="./astrochart.js"></script>
	```
3. ç‰ˆæœ¬é”å®šï¼šæŠŠæ–‡ä»¶å…¥åº“æˆ–æ”¾åˆ°ä½ è‡ªå·±çš„ç§æœ‰é™æ€æœåŠ¡å™¨ã€‚

### index.html å½“å‰åŠ è½½é¡ºåºï¼ˆç²¾ç®€ç‰ˆï¼‰

1. è¿œç¨‹ï¼š`raw.githubusercontent.com/AstroDraw/AstroChart/main/dist/astrochart.js`
2. å¤±è´¥ â†’ æœ¬åœ° `./astrochart.js`

æ³¨æ„ï¼š`main` åˆ†æ”¯æ–‡ä»¶ä¼šéšé¡¹ç›®æ¼”è¿›è€Œå˜åŒ–ï¼Œè‹¥éœ€è¦ç¨³å®šå¯å¤ç°ç»“æœï¼Œå»ºè®®æ”¹ä¸ºæŸä¸ª release tagï¼Œä¾‹å¦‚ï¼š

```
https://raw.githubusercontent.com/AstroDraw/AstroChart/v1.5.0/dist/astrochart.js
```

æˆ–ç›´æ¥å°†è¯¥ç‰ˆæœ¬æ–‡ä»¶æäº¤åˆ°ä½ è‡ªå·±çš„ä»“åº“å¹¶å¼•ç”¨ç›¸å¯¹è·¯å¾„ã€‚

## ä½¿ç”¨ Swiss Ephemeris è‡ªåŠ¨ç”Ÿæˆ planets/cusps

æœ¬é¡¹ç›®æ–°å¢ `swisseph` è¾…åŠ©è„šæœ¬ï¼Œè‡ªåŠ¨æ ¹æ®æ—¥æœŸ + ç»çº¬åº¦ è®¡ç®—è¡Œæ˜Ÿé»„é“åº¦æ•°ä¸ 12 å®«é¦–ï¼Œç„¶åå†äº¤ç»™ AstroChart ç»˜å›¾ã€‚AstroChart è‡ªèº«ä¸åšå¤©æ–‡è®¡ç®—ï¼Œè¿™ä¸ªæ­¥éª¤æ˜¯â€œæ•°æ®å‡†å¤‡å±‚â€ã€‚

### 1. å®‰è£…ä¾èµ–ï¼ˆå·²æ‰§è¡Œå¯è·³è¿‡ï¼‰
```bash
npm install
```

### 2. ç”Ÿæˆç¤ºä¾‹æ•°æ®
é»˜è®¤è„šæœ¬å‚æ•°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰ï¼š
```bash
npm run gen
```
ç­‰ä»·äºï¼š
```bash
node scripts/generate-data.js \
	--date "1995-08-19T10:25:00+08:00" \
	--lat 30.6 \
	--lon 114.3 \
	--house P \
	--out data.json
```
è¾“å‡ºæ–‡ä»¶ï¼š`data.json`ï¼Œç»“æ„å¦‚ä¸‹ï¼ˆæˆªæ–­ç¤ºä¾‹ï¼‰ï¼š
```json
{
	"meta": { "source": "swisseph", "dateInput": "..." },
	"planets": {
		"Sun": [ 146.123456, 0.985647 ],
		"Moon": [ 210.987654, -12.345678 ],
		"NNode": [ 156.432100, -0.052321 ]
	},
	"cusps": [ 123.45, 156.78, ...  ]
}
```

### 3. åœ¨å‰ç«¯ä½¿ç”¨ç”Ÿæˆæ•°æ®
å¯ä»¥æŠŠ `index.html` ä¸­çš„é™æ€ `data` æ›¿æ¢ä¸ºåŠ¨æ€åŠ è½½ï¼š
```html
<script>
fetch('./data.json')
	.then(r => r.json())
	.then(ephem => {
		const data = { planets: ephem.planets, cusps: ephem.cusps };
		const chart = new window.astrochart.Chart('chart', 600, 600);
		chart.radix(data).aspects();
	});
</script>
```

### 4. é€Ÿåº¦ä¸é€†è¡Œ
è„šæœ¬ä¸­ç¬¬äºŒä¸ªå€¼æ˜¯è¡Œæ˜Ÿé»„ç»é€Ÿåº¦ï¼ˆè‹¥ä¸ºè´Ÿè¡¨ç¤ºé€†è¡Œï¼Œå¯ç”¨äº UI æ ‡è®°ï¼‰ã€‚AstroChart é»˜è®¤ä¸ä¼šè‡ªåŠ¨åŠ â€œRâ€é€»è¾‘åˆ°ä½ çš„è¡Œæ˜Ÿé›†ï¼ˆé™¤éåœ¨ transit ä¸­ï¼‰ï¼Œä½ å¯ä»¥è‡ªè¡Œæ‰©å±•æ–‡æœ¬æ˜¾ç¤ºã€‚

### 5. å®«ä½ç³»ç»Ÿ
å½“å‰å‚æ•° `--house P` ä½¿ç”¨ Placidusï¼Œå¯æ›¿æ¢ï¼š`K` (Koch), `R` (Regiomontanus) ç­‰ï¼ˆå…·ä½“å–å†³äº swisseph æ”¯æŒï¼‰ã€‚è‹¥è®¡ç®—å¤±è´¥è„šæœ¬ä¼šç»§ç»­è¾“å‡ºè¡Œæ˜Ÿï¼Œä½†å®«ä½å¯èƒ½ä¸ºç©ºæ•°ç»„ã€‚

### 6. å¸¸è§è®¡ç®—é—®é¢˜
| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³ |
|------|----------|------|
| Planet calc failed | æŸé¢—è¡Œæ˜Ÿè®¡ç®—å‡ºé”™ | å¿½ç•¥/é‡è¯•ï¼›æ£€æŸ¥ swisseph ç‰ˆæœ¬ | 
| House calc failed | ç»åº¦/çº¬åº¦æ ¼å¼æˆ– house system ä¸æ”¯æŒ | æ¢ç³»ç»Ÿ æˆ– æ£€æŸ¥å‚æ•° | 
| data.json cusps ä¸ºç©º | å®«ä½å¤±è´¥ | é‡æ–°æŒ‡å®š `--house` | 

### 7. ç‰ˆæƒä¸è®¸å¯æé†’
Swiss Ephemeris æœ‰å…¶è®¸å¯æ¡æ¬¾ï¼ˆGPL/ä¸“ä¸šæˆæƒæ¨¡å¼ï¼‰ã€‚ç”Ÿäº§ç”¨é€”è¯·ç¡®è®¤åˆè§„ï¼›æ¼”ç¤º/å­¦ä¹ ç”¨é€”ä¸€èˆ¬é—®é¢˜ä¸å¤§ã€‚

---
éœ€è¦æˆ‘æŠŠ `index.html` è‡ªåŠ¨æ”¹é€ æˆåŠ¨æ€åŠ è½½ `data.json` çš„ç‰ˆæœ¬ï¼Œæˆ–è€…å†åŠ ä¸€ä¸ªç‹¬ç«‹ `generated.html` ç¤ºä¾‹å—ï¼Ÿå‘Šè¯‰æˆ‘å³å¯ã€‚

## åŠ¨æ€è¡¨å• + åç«¯ APIï¼ˆswisseph + AstroChartï¼‰è°ƒç”¨æµç¨‹è¯´æ˜

æœ¬ Demo è¿˜åŒ…å«ä¸€ä¸ªâ€œè¾“å…¥å‡ºç”Ÿæ—¥æœŸæ—¶é—´ + ç»çº¬åº¦ + æ—¶åŒº â†’ è‡ªåŠ¨è®¡ç®—è¡Œæ˜Ÿä¸å®«ä½ â†’ ç»˜åˆ¶æ˜Ÿç›˜â€çš„å®Œæ•´é—­ç¯ã€‚æ ¸å¿ƒæ˜¯å‰åç«¯åˆ†å±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     fetch(GET)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨è¡¨å•  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚ /api/ephemeris (Express + swe) â”‚
â”‚ (index.html) â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€ JSON â”€â”€â”€ â”‚  è®¡ç®—è¡Œæ˜Ÿ+å®«ä½ï¼Œè¿”å›æ•°æ®        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
			â”‚ ç»„è£… {planets,cusps}                     â”‚
			â–¼                                         â”‚swisseph è°ƒç”¨é¡ºåº
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ new astrochart.Chart()   â”‚                    â”‚ 1) swe_set_ephe_path()
â”‚   .radix(data).aspects() â”‚                    â”‚ 2) swe_julday()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ 3) swe_calc_ut() (å¾ªç¯å„è¡Œæ˜Ÿ)
							SVG æ¸²æŸ“                           â”‚ 4) swe_houses / swe_houses_ex2()
```

### å‰ç«¯ï¼ˆ`index.html`ï¼‰å…³é”®é€»è¾‘
1. ç”¨æˆ·å¡«å†™ï¼š`datetime-local`ã€æ—¶åŒºåç§» (tz)ã€çº¬åº¦ (lat)ã€ç»åº¦ (lon)ã€å®«ä½ç³»ç»Ÿ (house)ã€‚
2. ç›‘å¬è¡¨å• submitï¼šæ„é€  query string è°ƒç”¨ `/api/ephemeris`ã€‚
3. æ‹¿åˆ°å“åº” `{ planets, cusps }` åï¼š
	 ```js
	 const chart = new window.astrochart.Chart('chart', 600, 600);
	 chart.radix({ planets, cusps }).aspects();
	 ```
4. æ¯æ¬¡é‡æ–°ç”Ÿæˆä¼šæ¸…ç©ºæ—§å›¾å®¹å™¨å†æ¸²æŸ“æ–° SVGã€‚

### åç«¯ï¼ˆ`server.js`ï¼‰æ ¸å¿ƒç‰‡æ®µæ¦‚è§ˆ
```js
// 1) å‚æ•°è§£æ (date, tz, lat, lon, house)
// 2) æœ¬åœ°æ—¶é—´ -> UTC -> å„’ç•¥æ—¥
const jd = swe.swe_julday(year, month, day, hourDec, swe.SE_GREG_CAL);

// 3) è¡Œæ˜Ÿå¾ªç¯ (Sun ... NNode)
swe.swe_calc_ut(jd, planetId, swe.SEFLG_SWIEPH, cb)
// è¿”å› longitude / speedLong

// 4) å®«ä½
// ä¼˜å…ˆæ‰©å±•: swe_houses_ex2 / swe_houses_ex / fallback swe_houses
// å¾—åˆ° houses.cusps[1..12]

// 5) è‹¥å®«ä½å¤±è´¥æˆ–ä¸è¶³ 12 ä¸ªï¼Œä½¿ç”¨ fallback ç­‰é—´è· 30Â° ç”Ÿæˆ

// 6) è¿”å› JSON ç»™å‰ç«¯
res.json({ meta:{...}, planets, cusps })
```

### å­—æ®µè¯´æ˜å†æ¬¡æ±‡æ€»
| å­—æ®µ | å«ä¹‰ | å¤‡æ³¨ |
|------|------|------|
| planets[Name][0] | è¡Œæ˜Ÿé»„é“åº¦æ•° (0â€“360) | ä¾‹å¦‚ Sun, Moon, Mercury ... NNode |
| planets[Name][1] | é»„ç»é€Ÿåº¦ | < 0 ä»£è¡¨é€†è¡Œï¼Œå¯ç”¨äºæ˜¾ç¤º â€œRâ€ |
| cusps | 12 å®«é¦–åº¦æ•° | å¤±è´¥åˆ™ fallback ç­‰é—´è· |
| meta.jd | å„’ç•¥æ—¥ | å¯ç”¨äºåç»­æ›´æ·±è®¡ç®— |
| meta.cuspsSource | 'houses' æˆ– 'fallback' | æ–¹ä¾¿å‰ç«¯æ˜¾ç¤ºâ€œæ˜¯å¦çœŸå®å®«ä½â€æç¤º |

### ä¸ºä»€ä¹ˆéœ€è¦åç«¯ï¼Ÿ
AstroChart ä¸å†…ç½®å¤©æ–‡è®¡ç®—ã€‚æŠŠå¤©æ–‡ï¼ˆè¡Œæ˜Ÿ/å®«ä½ï¼‰ä¸æ¸²æŸ“è§£è€¦æœ‰è¿™äº›å¥½å¤„ï¼š
1. å®‰å…¨ï¼šEphemeris é€»è¾‘ä¸æš´éœ²æµè§ˆå™¨ç»†èŠ‚ï¼›å¯åšæƒé™æ§åˆ¶/é™æµã€‚
2. é‡å¤åˆ©ç”¨ï¼šåŒä¸€å¥—è®¡ç®—æ¥å£å¯æœåŠ¡å¤šä¸ªå‰ç«¯ï¼ˆWeb / ç§»åŠ¨ / å°ç¨‹åºï¼‰ã€‚
3. å¯ç¼“å­˜ï¼šçƒ­é—¨å‡ºç”Ÿæ•°æ®æˆ–â€œä»Šå¤©æ­¤åˆ»â€æ•°æ®å¯ç›´æ¥ç¼“å­˜å“åº”ã€‚

### å›é€€ç­–ç•¥ (Fallback)
è‹¥ `swe_houses*` ç³»åˆ—æ— æ³•äº§å‡º 12 ä¸ªå®«é¦–ï¼š
1. ä»è¿”å›è¡Œæ˜Ÿæ•°æ®ï¼ˆä¸å½±å“åŸºæœ¬å±•ç¤ºï¼‰ã€‚
2. ä»¥ 0Â°,30Â°,60Â°â€¦ çº¿æ€§å¡«å…… 12 ä¸ª cusps å¹¶æ ‡æ³¨ `meta.cuspsSource='fallback'`ã€‚
3. å‰ç«¯å¯åœ¨çŠ¶æ€æ æç¤ºç”¨æˆ·â€œå®«ä½ä¸ºå›é€€ï¼Œä»…æ¼”ç¤ºâ€ã€‚

### é€†è¡Œæ ‡è®°ï¼ˆå¯è‡ªè¡Œæ‰©å±•ï¼‰
å‰ç«¯æ‹¿åˆ° `planets` åï¼Œå¯äºŒæ¬¡å¤„ç†ï¼š
```js
Object.entries(planets).forEach(([name, [lon, speed]]) => {
	if (speed < 0) {
		// å¯ä»¥åœ¨å›¾ä¸Šè¿½åŠ  'R' æ ‡è®°ï¼Œæˆ–åˆ—è¡¨å±•ç¤º
	}
});
```

### æ€§èƒ½ä¸æ‰©å±•å»ºè®®
| åœºæ™¯ | å»ºè®® |
|------|------|
| é«˜é¢‘è¯·æ±‚åŒä¸€æ—¶é—´ | åœ¨æœåŠ¡å™¨å¯¹ (date,tz,lat,lon,house) åšå†…å­˜ç¼“å­˜ (Map/LRU) |
| éœ€è¦æ›´å¤šç‚¹ | æ‰©å±• `PLANETS` åŠ  Chiron, Lilith, Fortuneï¼ˆéœ€è¦è‡ªè¡Œè®¡ç®—æˆ–æ¢ IDï¼‰ |
| éœ€è¦çœŸæœˆäº¤ç‚¹ | æŠŠ `swe.SE_MEAN_NODE` æ¢æˆ `swe.SE_TRUE_NODE` |
| éœ€è¦æ‰¹é‡ç”Ÿæˆ | å¢åŠ  POST æ¥å£ï¼Œä¸€æ¬¡å‘é€å¤šä¸ªæ—¥æœŸåœ°ç‚¹ |
| éœ€è¦ SSR å›¾ç‰‡ | ç”¨ headless æµè§ˆå™¨æˆ– svg->png è½¬æ¢æœåŠ¡ |

### ç«¯åˆ°ç«¯æœ€ç®€é‡ç°æ­¥éª¤
```bash
npm install              # å®‰è£…ä¾èµ–
npm start                # å¯åŠ¨ express + /api/ephemeris
# æµè§ˆå™¨è®¿é—®ç«¯å£ (Codespaces æˆ– localhost:3000)
# å¡«å†™è¡¨å•ç‚¹å‡» ç”Ÿæˆæ˜Ÿç›˜ â†’ å³æ—¶ç”Ÿæˆ
```

---
å¦‚æœè¿˜æƒ³æ·»åŠ â€œé€†è¡Œ R æ ‡è®°æ¼”ç¤ºâ€æˆ–â€œtransit åŠ¨ç”»ç¤ºä¾‹â€ï¼Œéšæ—¶æéœ€æ±‚ï¼Œæˆ‘å¯ä»¥ç»§ç»­è¡¥å……ã€‚


