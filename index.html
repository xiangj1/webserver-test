<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>AstroChart 最简单示例</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { font-family: system-ui, Arial, sans-serif; background:#f5f7fa; margin:0; padding:24px; }
      h1 { margin-top:0; font-size:20px; }
      #chart { width:600px; height:600px; margin:12px 0; }
      .note { font-size:12px; color:#555; }
      @media (max-width:700px){ #chart { width:100%; height:100vw; max-height:600px; } }
    </style>
  </head>
  <body>
    <h1>AstroChart 动态生成年月日示例</h1>
    <form id="ephemeris-form" style="background:#fff;padding:12px;border:1px solid #ddd;max-width:640px;border-radius:6px;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;">
      <label style="display:flex;flex-direction:column;font-size:12px;gap:2px;">日期时间(本地)
        <input type="datetime-local" id="birth-dt" value="1995-08-19T10:25" required />
      </label>
      <label style="display:flex;flex-direction:column;font-size:12px;gap:2px;">时区偏移(小时)
        <input type="number" step="0.25" id="tz" value="8" />
      </label>
      <label style="display:flex;flex-direction:column;font-size:12px;gap:2px;">纬度(lat)
        <input type="number" step="0.0001" id="lat" value="30.6" required />
      </label>
      <label style="display:flex;flex-direction:column;font-size:12px;gap:2px;">经度(lon)
        <input type="number" step="0.0001" id="lon" value="114.3" required />
      </label>
      <label style="display:flex;flex-direction:column;font-size:12px;gap:2px;">宫位系统
        <select id="house">
          <option value="P" selected>Placidus (P)</option>
          <option value="K">Koch (K)</option>
          <option value="R">Regiomontanus (R)</option>
          <option value="O">Porphyrius (O)</option>
          <option value="C">Campanus (C)</option>
        </select>
      </label>
      <div style="display:flex;align-items:flex-end;">
        <button type="submit" style="padding:6px 14px;cursor:pointer;">生成星盘</button>
      </div>
      <div style="grid-column:1/-1;font-size:12px;color:#666;">说明：前端不直接做天文计算，表单会调用本地 Node API (/api/ephemeris) 得到行星+宫首数据再渲染。</div>
    </form>
    <div id="status" style="margin-top:8px;font-size:12px;color:#555;"></div>
    <div id="chart" style="margin-top:12px;"></div>
    <p class="note">如果远程 astrochart 加载失败会使用本地备份；可在控制台查看日志。</p>

    <!-- 使用 raw.githubusercontent.com 作为唯一远程源，失败则回退本地 ./astrochart.js -->
    <script>
      function loadLocalAstro(){
        const tag = document.createElement('script');
        tag.src = './astrochart.js?v=' + Date.now();
        tag.onload = () => console.log('[AstroChart] 已从本地 astrochart.js 加载');
        tag.onerror = () => console.error('[AstroChart] 本地 astrochart.js 加载失败，请确认文件存在');
        document.head.appendChild(tag);
      }
    </script>
    <!-- 远程单一源：raw（注意 main 可能变动，生产建议固定 tag，例如 v1.x.x） -->
    <script id="astrochart-raw" src="https://raw.githubusercontent.com/AstroDraw/AstroChart/main/dist/astrochart.js" onerror="loadLocalAstro()"></script>
    <script>

      let currentChartInstance = null;

      function waitAstroAnd(fn){
        if(!window.astrochart){
          return setTimeout(() => waitAstroAnd(fn), 60);
        }
        fn();
      }

      function renderChart(ephem){
        const planets = ephem.planets || {};
        const cusps = ephem.cusps || [];
        if(!cusps || cusps.length !== 12){
          console.warn('Cusps 数量不是 12，可能宫位计算失败。');
        }
        const data = { planets, cusps };
        const container = document.getElementById('chart');
        container.innerHTML = '';
        currentChartInstance = new window.astrochart.Chart('chart', 600, 600).radix(data);
        currentChartInstance.aspects();
      }

      async function fetchEphemeris(params){
        const qs = new URLSearchParams(params).toString();
        const status = document.getElementById('status');
        status.textContent = '计算中...';
        try {
          const resp = await fetch('/api/ephemeris?' + qs);
          if(!resp.ok) throw new Error('HTTP ' + resp.status);
          const json = await resp.json();
          status.textContent = '完成: JD=' + json.meta.jd.toFixed(2);
          renderChart(json);
        } catch(e){
          status.textContent = '失败: ' + e.message;
          console.error(e);
        }
      }

      document.getElementById('ephemeris-form').addEventListener('submit', e => {
        e.preventDefault();
        waitAstroAnd(() => {
          const dt = document.getElementById('birth-dt').value; // yyyy-MM-ddTHH:mm
          const tz = document.getElementById('tz').value || '0';
          const lat = document.getElementById('lat').value;
          const lon = document.getElementById('lon').value;
          const house = document.getElementById('house').value;
          if(!dt){
            alert('请输入日期时间');
            return;
          }
          fetchEphemeris({ date: dt + ':00', tz, lat, lon, house });
        });
      });

      // 初次加载触发一次默认值
      window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('ephemeris-form').dispatchEvent(new Event('submit'));
      });
    </script>
  </body>
</html>
